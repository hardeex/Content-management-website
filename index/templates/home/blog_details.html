{% extends 'home/base.html' %} 
{% load static %} 
{% load humanize %}


{% block title %} {{object.title}} {% endblock %} 

{% block body %} 
          <div class="post-title">
               <h1>{{object.title | upper}} </h1>
                    {% if user.is_authenticated %}                         
                                   <small>
                                   <b>Last Updated: {{object.date}}  </b> | <b>Author: </b>  {{object.author.first_name}} {{object.author.last_name}} |
                                   <b> Category:</b>  <a href="{% url 'index:category_list' object.category %}">{{object.category}}</a> |
                              {% if object.author.id == user.id  %}
                                        <a href="{% url 'index:edit_post' object.pk %}">(Edit)</a> |
                                        <a href="{% url 'index:delete_post' object.pk %}">(Delete)</a>
                              {% endif %}
                                        </small> <br> <br>    
                                        <p>
                                             {{object.content | safe}}
                                        </p>  <hr>

                              <form action="{% url 'index:like_post' object.pk %}" method="post">
                                   {% csrf_token %} 
                                   {% if liked %}
                                        <button type="submit"  class="btn btn-danger" name="post_id" value="{{object.id}}">Unliked </button> - {{total_likes}} Likes
                                   {% else %} 
                                        <button type="submit"  class="btn btn-success" name="post_id" value="{{object.id}}">Likes - {{total_likes}} </button>
                                   {% endif %}
                              </form> <br>
          </div> <br>
        

               <!--- Author Profile Page

          

               -->                    
                    <div class="post-title"  >
                         <div class="row g-0">
                         <div class="col-md-2">

                         {% if object.author.profile.profile_pic %}
                              <img src="{{ object.author.profile.profile_pic.url }}" class="rounded-circle" alt="Author profile image" width="100" height="100">
                          {% else %}
                              <img src="{% static 'images/profile_user_icon.png' %}" class="rounded-circle" alt="Default profile image" width="100" height="100">
                          {% endif %}        
                         </div>
                         <div class="col-md-10">
                         <div class="card-body">
                              <h5 class="card-title">{{object.author.first_name|safe}} {{object.author.last_name|safe}}</h5>
                              
                              <small  class="fw-lighter">
                              {% if object.author.profile.email_url %}    
                                   <a href="mailto: {{object.author.profile.email_url}}" target="_blank">Email</a>                                                      
                              {% endif %}

                              {% if object.author.profile.website_url %}
                                   |<a href="{{object.author.profile.website_url}}" target="_blank">Website </a>                                     
                              {% endif %}
                              
                              
                              {% if object.author.profile.facebook_url %}
                                   |  <a href="{{object.author.profile.facebook_url}}" class="links" target="_blank">Facebook </a>                                  
                              {% endif %}
                              
                              
                              {% if object.author.profile.linkedln_url %}
                                   |  <a href="{{object.author.profile.linkedln_url}}" class="links" target="_blank">Linkedln </a> 
                              {% endif %}

                              
                              {% if object.author.profile.twitter_url %}
                                   |  <a href="{{object.author.profile.twitter_url}}" class="links" target="_blank">Twitter </a> 
                              {% endif %}

                              {% if object.author.profile.instagram_url %}                                   
                                   |  <a href="{{object.author.profile.instagram_url}}" class="links" target="_blank">Instagram </a>                                  
                              {% endif %}                                   
                              
                              
                              {% if object.author.profile.whatsapp_url %} 
                                   |  <a href="{{object.author.profile.whatsapp_url}}" class="links" target="_blank"> WhatsApp </a>
                              {% endif %}
                              
                              
                              {% if object.author.profile.github_url %}
                              
                                   |  <a href="{{object.author.profile.github_url}}" class="links" target="_blank">GitHub </a> 
                              {% endif %}

                              </small>
                              <p class="card-text">                                  
                                   {{object.author.profile.bio |truncatewords:"80" |safe}}                                    
                                   {% if object.author.profile.pk %}
                                   ... <a href="{% url 'account:user_profile' object.author.profile.pk %}" class="link-info link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover", target="_blank">
                                       Read More...                                   
                                   </a>   
                                   {% endif %}
                                   </p>
                              
                         </div>
                         </div>
                         </div>
                    </div>


                    <!---View of comment for logged in user--> <br><br>
                    <div class="post-title">
                         {% with comments.count as total_comments %} 
                         <h2>
                             {{ total_comments }} Comment{{ total_comments|pluralize }}                               
                         </h2>
                         <small>Discussion on: {{ object.title }}</small><hr>
                         {% endwith %} 
                     
                         {% load mptt_tags %} 
                         <div>
                             {% recursetree comments %} 
                             <small><b>{{ node.user }}</b> - {{ node.date }} ({{ node.date|naturaltime }})</small>
                             <div class="parent-comment" id="{{ node.id }}">{{ node.content|safe }}</div>                      
                            
                             <button type="button"class="btn btn-primary"  onclick="myFunction('{{ node.id }}')">Reply</button>
                             <div>
                                 {% if not node.is_leaf_node %} 
                                 <div class="children-comment">{{ children }} </div> <hr>
                                 {% endif %}
                             </div>     
                     
                             {% endrecursetree %}
                         </div>
                     
                         <br><br>
                         <div>
                             <h2>Make a new comment</h2>
                             <form id="myForm" method="POST" action="{% url 'index:add_comment' object.id %}"> 
                                 {% csrf_token %}
                                 {{ comment_form.as_p }} 
                                 {{ form.media }}                                                                                            
                                 <button type="submit" class="btn btn-secondary">Add comment</button>
                             </form>
                         </div>
                     
                     
                         <script>
                            
                     
                             function myFunction(id) {
                                        var existingForm = document.getElementById("newForm");
                                        if (existingForm) {
                                             existingForm.remove();
                                        }

                                        var reply = document.getElementById(id);
                                        var formHTML = `
                                        <form id="newForm" method="POST" class="form-insert py-2" action="{% url 'index:add_comment' object.pk %}">
                                                  <div><h2>Reply</h2></div>
                                                  <select name="parent" class="d-none" id="id_parent">
                                                       <option value="${id}" selected="${id}"></option>
                                                  </select>
                                                  <label for="id_content">Content:</label>
                                                  <textarea name="content" cols="40" rows="5" class="form-control" required id="id_content"></textarea>
                                                  {% csrf_token %}
                                                  {{ form.media }}
                                                  <button type="submit" class="btn-primary btn-lg btn-block">Add comment</button>
                                             </form>
                                        `;

                                        reply.insertAdjacentHTML("afterend", formHTML);
                                        }

                       
                         </script>  
                     
                         <style>
                             .parent-comment {
                                 
                             }
                             .children-comment {
                                 margin-left:40px;
                                 
                             }
                         </style>
                     </div>
                     

                    <!---End of view of comment for logged in user-->

               <!--- End Author Profile Page-->

          <!-- views for users not logged in-->
          {% else %} 
          <div class="post-title">
               <small>
                              <b>Last Updated: </b>  {{object.date}} | <b>Author: </b>  {{object.author.first_name}} {{object.author.last_name}}               
                              </small> <br> <br>    
                              <p>
                                   {{object.content | safe}}
                              </p> <hr>
                              <small><a  href="{% url 'login' %}">Login</a> to Like Posts, Comment and view the author bio - {{total_likes}} Likes </small>
          </div>
               <br><br><br>


          <!-- Viewing the comments -->

          
         
          
          <!--End of  Viewing the comments -->


          {% endif %}
          <!-- End of views for users not logged in-->
          <br><br><br><br> <a href="{% url 'index:blog_list' %}" class="btn btn-primary">Back To Posts List</a><br><br>

          <style>
               .post-title{
                    margin: auto;
                    width: 55rem;
                    text-align: justify;               
               }
          </style>
{% endblock %}